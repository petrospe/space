<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pulsar in a Globular Cluster with Galaxy</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; }

    #exit-button {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      z-index: 999;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 10px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    #exit-button:hover {
      background: rgba(255, 0, 0, 0.7);
    }
  </style>
</head>
<body>
  <div id="exit-button">âœ–</div>
  <script>
    function loadScript(src, callback) {
      const script = document.createElement('script');
      script.src = src;
      script.onload = callback;
      document.head.appendChild(script);
    }

    loadScript('https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js', () => {
      loadScript('https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js', initApp);
    });

    function initApp() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 50;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        // Limit zoom out to prevent seeing black hole
        controls.minDistance = 5;
        controls.maxDistance = 100;

        // Enhanced lighting for more realistic pulsar
        scene.add(new THREE.AmbientLight(0x111111));
        
        // Pulsar core light
        const pulsarLight = new THREE.PointLight(0xffffff, 2, 50);
        pulsarLight.position.set(0, 0, 0);
        scene.add(pulsarLight);
        
        // Jet lighting
        const jetLight1 = new THREE.PointLight(0x87ceeb, 1, 30);
        jetLight1.position.set(0, 10, 0);
        scene.add(jetLight1);
        
        const jetLight2 = new THREE.PointLight(0x87ceeb, 1, 30);
        jetLight2.position.set(0, -10, 0);
        scene.add(jetLight2);

        // ðŸŒŒ Cosmic Background - Reliable galaxy background
        const loader = new THREE.TextureLoader();
        loader.load('images/starmap_random_2020_4k_gal.png', texture => {
            // Create a very large background sphere
            const bgGeo = new THREE.SphereGeometry(500, 64, 64);
            const bgMat = new THREE.MeshBasicMaterial({ 
                map: texture, 
                side: THREE.BackSide 
            });
            const background = new THREE.Mesh(bgGeo, bgMat);
            scene.add(background);
            
            // Keep background centered and static
            background.position.set(0, 0, 0);
        });

        // âœ¨ Circular texture for cluster stars
        const starTexture = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
        const clusterMaterial = new THREE.PointsMaterial({
            color: 0xffffff,
            size: 0.4,
            map: starTexture,
            transparent: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        // ðŸŒ€ Globular Cluster
        const starCount = 3000;
        const positions = [];
        for (let i = 0; i < starCount; i++) {
            let r = Math.random() * 20 + 5; // Avoid center overlap
            const theta = Math.random() * 2 * Math.PI;
            const phi = Math.acos(2 * Math.random() - 1);
            const x = r * Math.sin(phi) * Math.cos(theta);
            const y = r * Math.sin(phi) * Math.sin(theta);
            const z = r * Math.cos(phi);
            positions.push(x, y, z);
        }

        const clusterGeometry = new THREE.BufferGeometry().setAttribute(
            'position',
            new THREE.Float32BufferAttribute(positions, 3)
        );
        const cluster = new THREE.Points(clusterGeometry, clusterMaterial);
        scene.add(cluster);

        // ðŸŒŸ Pulsar (neutron star) - More realistic
        const pulsarGeo = new THREE.SphereGeometry(1.0, 64, 64);
        
        // Create a more realistic neutron star material
        const pulsarMat = new THREE.MeshStandardMaterial({ 
            color: 0xffffff,
            emissive: 0x444444,
            emissiveIntensity: 0.8,
            roughness: 0.1,
            metalness: 0.9,
            side: THREE.DoubleSide
        });
        
        const pulsar = new THREE.Mesh(pulsarGeo, pulsarMat);
        scene.add(pulsar);

        // Add surface details with displacement
        const displacementMap = new THREE.TextureLoader().load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg');
        pulsarMat.displacementMap = displacementMap;
        pulsarMat.displacementScale = 0.1;

        // ðŸ“¡ Realistic Radio Jets with multiple components
        const jetGroup = new THREE.Group();
        scene.add(jetGroup);

        // Main jet material - more realistic blue-white
        const jetMaterial = new THREE.MeshBasicMaterial({
            color: 0x87ceeb,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        // High-energy particle jet material
        const particleJetMaterial = new THREE.MeshBasicMaterial({
            color: 0xffffff,
            transparent: true,
            opacity: 0.6,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        const jetHeight = 15;
        const jetRadius = 0.2;

        // Top Jet - Main radio beam
        const topJetGeo = new THREE.ConeGeometry(jetRadius, jetHeight, 32, 1, true);
        const topJet = new THREE.Mesh(topJetGeo, jetMaterial);
        topJet.position.set(0, jetHeight / 2, 0);
        jetGroup.add(topJet);

        // Bottom Jet
        const bottomJet = topJet.clone();
        bottomJet.rotation.x = Math.PI;
        bottomJet.position.set(0, -jetHeight / 2, 0);
        jetGroup.add(bottomJet);

        // High-energy particle jets (narrower, more focused)
        const particleJetGeo = new THREE.ConeGeometry(jetRadius * 0.3, jetHeight * 1.2, 16, 1, true);
        const topParticleJet = new THREE.Mesh(particleJetGeo, particleJetMaterial);
        topParticleJet.position.set(0, jetHeight * 0.6, 0);
        jetGroup.add(topParticleJet);

        const bottomParticleJet = topParticleJet.clone();
        bottomParticleJet.rotation.x = Math.PI;
        bottomParticleJet.position.set(0, -jetHeight * 0.6, 0);
        jetGroup.add(bottomParticleJet);

        // Attach jet group to pulsar
        pulsar.add(jetGroup);

        // ðŸŒŸ Accretion Disk around pulsar
        const diskGeometry = new THREE.RingGeometry(1.5, 8, 64);
        const diskMaterial = new THREE.MeshBasicMaterial({
            color: 0xff6b6b,
            transparent: true,
            opacity: 0.7,
            side: THREE.DoubleSide,
            blending: THREE.AdditiveBlending
        });
        const accretionDisk = new THREE.Mesh(diskGeometry, diskMaterial);
        accretionDisk.rotation.x = Math.PI / 2; // Rotate to be horizontal
        pulsar.add(accretionDisk);

        // ðŸŒŸ Pulsar beam (sprite) - more realistic
        const beamTexture = new THREE.TextureLoader().load('https://threejs.org/examples/textures/lensflare/lensflare0.png');
        const beamMat = new THREE.SpriteMaterial({
            map: beamTexture,
            color: 0xffffff,
            blending: THREE.AdditiveBlending,
            transparent: true
        });
        const beam = new THREE.Sprite(beamMat);
        beam.scale.set(8, 8, 1.0);
        scene.add(beam);

        // Add magnetic field lines visualization
        const fieldLineGeometry = new THREE.BufferGeometry();
        const fieldLinePositions = [];
        const fieldLineCount = 8;
        
        for (let i = 0; i < fieldLineCount; i++) {
            const angle = (i / fieldLineCount) * Math.PI * 2;
            const radius = 3;
            const height = 6;
            
            // Create curved field lines
            for (let j = 0; j <= 20; j++) {
                const t = j / 20;
                const x = Math.cos(angle) * radius * Math.cos(t * Math.PI);
                const y = height * (t - 0.5) * 2;
                const z = Math.sin(angle) * radius * Math.cos(t * Math.PI);
                fieldLinePositions.push(x, y, z);
            }
        }
        
        fieldLineGeometry.setAttribute('position', new THREE.Float32BufferAttribute(fieldLinePositions, 3));
        const fieldLineMaterial = new THREE.LineBasicMaterial({
            color: 0x00ffff,
            transparent: true,
            opacity: 0.3
        });
        const fieldLines = new THREE.Line(fieldLineGeometry, fieldLineMaterial);
        pulsar.add(fieldLines);

        // ðŸŽ¬ Animate - More realistic pulsar behavior
        let pulseScale = 1;
        let scaleDirection = 1;
        let pulsePhase = 0;

        function animate() {
            requestAnimationFrame(animate);

            // Realistic pulsar rotation (very fast)
            pulsar.rotation.y += 0.15;
            pulsar.rotation.x += 0.03;

            // Accretion disk rotation
            accretionDisk.rotation.z += 0.02;

            // Pulsar beam pulsing (more realistic timing)
            pulsePhase += 0.1;
            pulseScale = 1 + Math.sin(pulsePhase) * 0.8;
            beam.scale.set(pulseScale * 6, pulseScale * 6, 1);
            beam.position.copy(pulsar.position);

            // Jet intensity variation
            const jetIntensity = 0.6 + Math.sin(pulsePhase * 2) * 0.3;
            jetMaterial.opacity = jetIntensity;
            particleJetMaterial.opacity = jetIntensity * 0.8;

            // Accretion disk brightness variation
            const diskBrightness = 0.5 + Math.sin(pulsePhase * 1.5) * 0.3;
            diskMaterial.opacity = diskBrightness;

            // Field lines rotation
            fieldLines.rotation.y += 0.01;

            // Pulsar light intensity variation
            const lightIntensity = 1.5 + Math.sin(pulsePhase * 3) * 0.8;
            pulsarLight.intensity = lightIntensity;
            
            // Jet lights intensity
            const jetLightIntensity = 0.8 + Math.sin(pulsePhase * 2) * 0.4;
            jetLight1.intensity = jetLightIntensity;
            jetLight2.intensity = jetLightIntensity;

            // Background is now static and large enough to always cover the view

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }
   
    document.getElementById('exit-button').addEventListener('click', () => {
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
